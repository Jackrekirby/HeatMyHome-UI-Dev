<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="test.css" />
    <title>Document</title>
  </head>
  <body>
    <nav class="flex row">
      <div>
        <img onclick="pageTo(0);" src="./images/logo.svg" alt="HeatMyHome" />
      </div>
      <!-- <div class="title">HeatMyHome | 0.13</div> -->
      <div id="nav-menu" class="flex row">
        <div onclick="pageTo(1);" class="link">Learn</div>
        <div onclick="pageTo(2);" class="link">About</div>
        <div onclick="pageTo(3);" class="button link">Simulate</div>
      </div>
    </nav>
    <div class="nav-buffer"></div>
    <div class="parent background radial sc5">
      <section class="page home">
        <div>
          <h1>Heat My Home</h1>
          <div onclick="pageTo(3);" class="link">Simulate</div>
        </div>
        <img id="home__img" src="./images/pic1.svg" />
      </section>
      <section class="page">
        <section class="subeducation">
          <h2>Education</h2>
          <div class="button-row">
            <button class="left" onclick="viewMode(0);">compact</button>
            <button class="middle">view</button>
            <button class="right active" onclick="viewMode(1);">expanded</button>
          </div>
          <div id="education-expanded" class="parent3">
            <div class="containers sc5">
              <div class="container">
                <div class="img">heat tech</div>
                <h2>
                  Heating<br />
                  Technologies
                </h2>
                <p>
                  Learn about the various low carbon heating technologies that
                  could heat your home.
                </p>
                <a href="./education/heating-technologies.html">Read more</a>
              </div>
              <div class="container">
                <div class="img">solar tech</div>
                <h2>
                  Solar<br />
                  Technologies
                </h2>
                <p>
                  Learn about the various solar thermal and photovoltaic
                  technologies that could supplement your heating system.
                </p>
                <a href="./education/solar-technologies.html">Read more</a>
              </div>
              <div class="container">
                <div class="img">why switch</div>
                <h2>
                  Why<br />
                  Switch?
                </h2>
                <p>
                  Learn about the various reasons switching to a low-carbon
                  heating technology could be beneficial to you and the planet!
                </p>
                <a href="./education/why-switch.html">Read more</a>
              </div>
              <div class="container">
                <div class="img">inputs</div>
                <h2>
                  Simulator<br />
                  Inputs
                </h2>
                <p>
                  Learn about the what each of the inputs into the simulator are,
                  and how they are used to determine your optimal heating system.
                </p>
                <a onclick="openSubEdu(1);">Read more</a>
              </div>
              <div class="container">
                <div class="img">outputs</div>
                <h2>
                  Simulator<br />
                  Outputs
                </h2>
                <p>
                  Learn about the what the data the simulator outputs, and how you
                  can use it to inform your choice of heating system.
                </p>
                <a href="./education/simulator-outputs.html">Read more</a>
              </div>
              <div class="container">
                <div class="img">how-it-works</div>
                <h2>
                  Simulator<br />
                  How-It-Works
                </h2>
                <p>
                  Learn about how the simulator determines the optimal heating
                  systems for your home.
                </p>
                <a href="./education/simulator-how-it-works.html">Read more</a>
              </div>
            </div>
            <div class="dots">
              <div onclick="test123(0);"></div>
              <div onclick="test123(1);"></div>
              <div onclick="test123(2);"></div>
              <div onclick="test123(3);"></div>
              <div onclick="test123(4);"></div>
              <div onclick="test123(5);"></div>
            </div>
          </div>
          <div id="education-compact" class="hide">
            <p>Why Switch?</p>
            <p>Heating Technologies</p>
            <p>Solar Technologies</p>
            <p onclick="openSubEdu(1);">Simulator: Inputs</p>
            <p>Simulator: Outputs</p>
            <p>Simulator: How-It-Works</p>
          </div>
        </section>
        <section class="subeducation hide">
          <h2>Simulator Inputs</h2>
          <div class="carosel sc5">
            <p onclick="show_education_slide(0);">postcode</p>
            <p onclick="show_education_slide(1);">address</p>
            <p onclick="show_education_slide(2);">thermostat temperature</p>
            <p onclick="show_education_slide(3);">floor area</p>
            <p onclick="show_education_slide(4);">epc space heating</p>
            <p onclick="show_education_slide(5);">tes volume</p>
          </div>
          <div class="info"><div class="">
            <h1>Postcode</h1>
            <p>
              Your Postcode is needed to find the solar and temperature data for
              your area.
            </p>
            <p>
              If you are located in an area with below UK average yearly
              temperatures and solar irradiance (sunlight) the heating appliances
              will require more energy to heat your home, and the photovoltaic
              panels will generate less energy per unit area.
            </p>
          </div>
          <div class="hide">
            <h1>Address</h1>
            <p>
              Your address is needed to allow us to automatically find your homes
              floor area and Energy Performance Certificate (EPC).
            </p>
            <p>
              This can be found automatically only if you live in England or
              Wales. To find your Energy Performance Certificate manually
              (required for addresses located in Scotland) check out the
              <a href="https://www.gov.uk/find-energy-certificate"
                >UK government website</a
              >.
            </p>
          </div>
          <div class="hide">
            <h1>Thermostat Temperature</h1>
            <p>
              The temperature which you like your home at, in degrees Celcius, is
              used when simulating heating technologies for your home.
            </p>
            <p>
              Setting a higher thermostat temperature will require more energy,
              resulting in higher estimates for operational expenditure and
              emissions.
            </p>
          </div>
          <div class="hide">
            <h1>Floor Area</h1>
            <p>
              Your floor area, in units of meters squared, is used to estimate several factors about your home including:
              <ol>
                <li>The maximum number of solar panels your roof could support.</li>
                <li>The number of windows your home has, which affect your homes heating requirements.</li>
                <li>The amount of air in your home which has to be heating to your desired thermostat temperature.</li>
                </ol>
              </p>
            <p>Don't worry if you don't know your homes floor area, we automatically find it for you when you enter your address.</p>
          </div>
          <div class="hide">
            <h1>EPC Space Heating</h1>
            <p>
              An Energy Performance Certificate tells you on a scale of A-G, the energy efficiency of your home. 
              They were introduced in 2007 as a legal requirement for any building sold, letted or constructed and are valid for 10 years. 
            </p>
            <p>The most efficient homes are in band A, but the average UK home is between band D-E. Find out more information <a href="https://www.elmhurstenergy.co.uk/help-support/what-is-an-epc">here</a>.</p>
            <p>An Energy Performance Certificate provides a Space Heating value, which is an estimate of how much energy is requires to heat your home. We use this value to simulate heating your home.</p>
          </div>
          <div class="hide">
            <h1>Thermal Energy Storage Size</h1>
            <p>
              Thermal Energy Storage (TES) simply refers to your hot water tank. Other methods of storing thermal energy do exist, but a hot water tank is the most commmon option and is the one used for simulations.
            </p>
            <p>
              A larger TES volume, in units of meters cubed, allows your heating system to prepare hot water in advance. 
              This is beneficial as it allows your heating system to heat the hot water tank at off-peak electricity times (often overnight), 
              rather than heat water on demand, which is often at peak times, when electricity costs are highest. 
            </p>
            <p>The cost of electricity 
              during peak and off-peak times depends on the type of tariff you have. This is why we simute 5 different electricity tariffs 
              and tell you the best tariff for each heating system.</p>
          </div></div>
          <button onclick="openSubEdu(0);">Return</button>
        </section>
      </section>
      <section class="page">About</section>
      <section class="page">
        <div class="form">
        <div class="input-field">
          <input type="text" id="postcode" maxlength=8 onfocusout="unfocusPostcode();" onfocus="focusPostcode();"/>
          <!-- <input type="text" id="postcode" maxlength=8 onfocusout="unfocusPostcode();" onfocus="focusPostcode();" onchange="testPostcode();" /> -->
          <p>postcode</p>
        </div>
        <select id="address" class="hide" onchange="testAddress();">
          <option>select address</option>
          <option>address not listed</option>
          <option>1 example avenue</option>
          <option>2 main street</option>
          <option>3 oakly road</option>
        </select>
        <button id="address-next" class="hide">next</button>
      </div>
      </section>
    </div>
    <script>
      console.log("script");
      let current_id = 0;
      function test123(id) {
        document
          .getElementsByClassName("containers")[0]
          .getElementsByClassName("container")
          [id].scrollIntoView({
            behavior: "smooth",
            block: "center",
            inline: "center",
          });

        document
          .getElementsByClassName("dots")[0]
          .getElementsByTagName("div")
          [id].classList.add("active");
        document
          .getElementsByClassName("dots")[0]
          .getElementsByTagName("div")
          [current_id].classList.remove("active");
        current_id = id;
      }
      function pageTo(id) {
        console.log("HERE");
        document
          .getElementsByClassName("parent")[0]
          .getElementsByClassName("page")
          [id].scrollIntoView({
            behavior: "smooth",
            block: "center",
            inline: "center",
          });
      }

      function viewMode(id) {
        let divs = document
          .getElementsByClassName("button-row")[0]
          .getElementsByTagName("button");
        if (id == 0) {
          document.getElementById("education-expanded").classList.add("hide");
          document.getElementById("education-compact").classList.remove("hide");
          divs[0].classList.add("active");
          divs[1].classList.add("active");
          divs[2].classList.remove("active");
        } else {
          document
            .getElementById("education-expanded")
            .classList.remove("hide");
          document.getElementById("education-compact").classList.add("hide");
          divs[0].classList.remove("active");
          divs[1].classList.remove("active");
          divs[2].classList.add("active");
        }
      }

      let cid = 0;
      function show_education_slide(id) {
        let ps = document.getElementsByClassName("carosel")[0].getElementsByTagName("p");
        ps[cid].classList.remove("active");
        ps[id].classList.add("active");

        let divs = document.getElementsByClassName("info")[0].getElementsByTagName("div");
        divs[id].classList.remove("hide");
        divs[cid].classList.add("hide");
        divs[cid].classList.remove("fadein");
        divs[id].classList.add("fadein");
        cid = id;
      }

      let bid = 0;
      function openSubEdu(id) {
        document.getElementsByClassName('subeducation')[id].classList.remove("hide");
        document.getElementsByClassName('subeducation')[bid].classList.add("hide");
        document.getElementsByClassName('subeducation')[id].classList.add("fadein");
        document.getElementsByClassName('subeducation')[bid].classList.remove("fadein");
        bid = id;
      }

      function focusPostcode(){
        let a = document.getElementById("postcode");
        a.classList.add("focus");
      }

      function unfocusPostcode(){
        let a = document.getElementById("postcode");
        a.classList.remove("focus");
      }


      // function focusAddress(){
      //   let a = document.getElementById("address");
      //   a.classList.add("focus");
      //   a.classList.remove("valid");
      //   a.classList.remove("invalid");
      // }

      // function unfocusAddress(){
      //   let a = document.getElementById("address");
      //   a.classList.remove("focus");
      //   testAddress()
      // }

      async function testPostcode() {
          let a = document.getElementById("postcode");
          let postcode = a.value;
          postcode = postcode.toUpperCase().replace(' ', '');
          a.value = postcode;
          // a.classList.remove("focus");
          let b = document.getElementById("address-next");
          let c = document.getElementById("address");
          b.classList.add("hide");
          if (postcode == "") {
            a.classList.remove("valid");
            a.classList.remove("invalid");
            
            document.getElementById("address").classList.add("hide");
          } else {
            const postcode_url = 'https://api.postcodes.io/postcodes/' + postcode;
          fetch(postcode_url).then(response => response.json())
              .then(data => {
                  if (data['status'] == 200) {
                      console.log('postcode api data:', data);
                      if (data.result.latitude != null && data.result.longitude != null) {
                        a.classList.add("valid");
                          a.classList.remove("invalid");
                          document.getElementById("address").classList.remove("hide");
                          document.getElementById("address").classList.remove("fadein");
                          document.getElementById("address").classList.add("fadein");
                          return true;
                      } {
                          throw new Error('Postcode found on API, but does not have an associated latitude and longitude.');
                      }
                  } else {
                    throw new Error(data['error']);
                  }
              })
              .catch((error) => {
                  console.error('Error:', error);
                  a.classList.add("invalid");
                  a.classList.remove("valid");
                  c.classList.add("hide");
                  c.value = "select address";
                  c.classList.remove("valid");
                  c.classList.remove("invalid");

                  return false;
              });
          }
      }

      function testAddress() {
        let a = document.getElementById("address");
        let b = document.getElementById("address-next");
        let address = a.value;

        console.log(address);
        switch (address) {
            case "select address":
              a.classList.remove("valid");
              a.classList.remove("invalid");
              b.classList.add("hide");
              break;
            case "address not listed":
              a.classList.remove("valid");
              a.classList.add("invalid");
              b.classList.add("hide");
              break;
            default:
              a.classList.add("valid");
              a.classList.remove("invalid");
              b.classList.remove("hide");

        }
      }

      function inputPostcode() {
        function invalidPostcode(a, c) {
          a.classList.add("invalid");
          a.classList.remove("valid");
          c.classList.add("hide");
          c.value = "select address";
          c.classList.remove("valid");
          c.classList.remove("invalid");
        }

        console.log("here");
        let a = document.getElementById("postcode");
        let b = document.getElementById("address-next");
        let c = document.getElementById("address");
          let postcode = a.value;
          postcode = postcode.toUpperCase().replace(' ', '');
          a.value = postcode;

          if (postcode.length > 4) {
            let hh = postcode.substr(-3,1);
            console.log("hh", hh);
            let h = postcode.substr(-2);
              console.log("h", h);
            if(!isNaN(hh) && /^[a-zA-Z]+$/.test(h)) {
                console.log("POSTCODE", hh, h);
                const postcode_url = 'https://api.postcodes.io/postcodes/' + postcode;
                fetch(postcode_url).then(response => response.json())
                    .then(data => {
                        if (data['status'] == 200) {
                            console.log('postcode api data:', data);
                            if (data.result.latitude != null && data.result.longitude != null) {
                              a.classList.add("valid");
                              a.classList.remove("invalid");

                              c.classList.remove("hide");
                              c.classList.remove("fadein");
                              c.classList.add("fadein");
                              find_address();
                            } else {
                                throw new Error('Postcode found on API, but does not have an associated latitude and longitude.');
                            }
                        } else {
                          throw new Error(data['error']);
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        invalidPostcode(a, c);
                });
            } else {
              invalidPostcode(a, c);
            }
          } else if (postcode.length > 0) {
            invalidPostcode(a, c);
          } else {
            a.classList.remove("invalid");
            a.classList.remove("valid"); 
          }
      } 


    function find_address() {
        console.log("find address");
        const postcode = document.getElementById('postcode').value;
        const api_url = 'http://localhost:3000';
        const epc_api_url = api_url + '/epc';
        fetch(`${epc_api_url}?postcode=${postcode}`).then(response => response.json())
            .then(data => {
                if (data['status'] == 200) {
                    console.log('addresses: ', data);
                    let element = document.getElementById('address');
                    //console.log(document.getElementsByTagName('option').length);
                    while (element.getElementsByTagName('option').length > 2) {
                        element.removeChild(element.lastChild);
                    }
                    for (const [address, certificate] of data.result) {
                        //console.log(address, certificate);
                        let option_ele = document.createElement('option');
                        option_ele.value = certificate;

                        let n = address.split(',', 2).join(',').length;

                        let address2 = address.toLowerCase().replace(/(^\w{1})|(\s+\w{1})/g, letter => letter.toUpperCase());

                        option_ele.text = address2.substring(0, 45);
                        element.appendChild(option_ele);
                    }
                } else {
                    throw new Error(data['error']);
                }
            })
            .catch((error) => {
                console.error('Could not find postcode on EPC API:', error);
                let element = document.getElementById('sim-addresses');
                while (element.getElementsByTagName('option').length > 0) {
                    element.removeChild(element.lastChild);
                }
                let option_ele = document.createElement('option');
                option_ele.text = 'Postcode not on EPC API';
                element.appendChild(option_ele);
            });;
    }

      let a = document.getElementById("postcode");
      a.addEventListener('input', inputPostcode);
    </script>
  </body>
</html>
