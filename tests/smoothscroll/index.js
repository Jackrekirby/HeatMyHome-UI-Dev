const output = {
    "demand": {
        "boiler": {
            "hot-water": 1460.07,
            "space": 1515.96,
            "total": 2976.03,
            "peak-hourly": 8.36874
        },
        "heat-pump": {
            "hot-water": 1460.07,
            "space": 1552.12,
            "total": 3012.19,
            "peak-hourly": 1.56076
        }
    },
    "systems": {
        "electric-boiler": {
            "none": {
                "pv-size": 0,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 232.091,
                "capital-expenditure": 678.913,
                "net-present-cost": 4092.94,
                "operational-emissions": 644775
            },
            "photovoltaic": {
                "pv-size": 14,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -35.5481,
                "capital-expenditure": 3758.91,
                "net-present-cost": 3236.01,
                "operational-emissions": 214478
            },
            "flat-plate": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 173.86,
                "capital-expenditure": 3256.41,
                "net-present-cost": 5813.87,
                "operational-emissions": 507729
            },
            "evacuated-tube": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 157.84,
                "capital-expenditure": 3366.41,
                "net-present-cost": 5688.21,
                "operational-emissions": 463252
            },
            "flat-plate-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -39.0105,
                "capital-expenditure": 5896.41,
                "net-present-cost": 5322.57,
                "operational-emissions": 182792
            },
            "evacuated-tube-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -64.4958,
                "capital-expenditure": 6006.41,
                "net-present-cost": 5057.69,
                "operational-emissions": 115537
            },
            "photovoltaic-thermal-hybrid": {
                "pv-size": 4,
                "solar-thermal-size": 4,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 102.037,
                "capital-expenditure": 5323.91,
                "net-present-cost": 6824.87,
                "operational-emissions": 364656
            }
        },
        "air-source-heat-pump": {
            "none": {
                "pv-size": 0,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 79.5922,
                "capital-expenditure": 6237.67,
                "net-present-cost": 7408.46,
                "operational-emissions": 232146
            },
            "photovoltaic": {
                "pv-size": 14,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -197.882,
                "capital-expenditure": 9317.67,
                "net-present-cost": 6406.86,
                "operational-emissions": -182272
            },
            "flat-plate": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 58.3877,
                "capital-expenditure": 8815.17,
                "net-present-cost": 9674.04,
                "operational-emissions": 191942
            },
            "evacuated-tube": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 52.8353,
                "capital-expenditure": 8925.17,
                "net-present-cost": 9702.37,
                "operational-emissions": 178927
            },
            "flat-plate-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -171.235,
                "capital-expenditure": 11455.2,
                "net-present-cost": 8936.33,
                "operational-emissions": -153667
            },
            "evacuated-tube-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -186.652,
                "capital-expenditure": 11565.2,
                "net-present-cost": 8819.54,
                "operational-emissions": -177541
            },
            "photovoltaic-thermal-hybrid": {
                "pv-size": 2,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 37.9702,
                "capital-expenditure": 10245.2,
                "net-present-cost": 10803.7,
                "operational-emissions": 158842
            }
        },
        "ground-source-heat-pump": {
            "none": {
                "pv-size": 0,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 53.459,
                "capital-expenditure": 7937.67,
                "net-present-cost": 8724.04,
                "operational-emissions": 154280
            },
            "photovoltaic": {
                "pv-size": 14,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -247.103,
                "capital-expenditure": 11017.7,
                "net-present-cost": 7382.83,
                "operational-emissions": -260026
            },
            "flat-plate": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 39.7321,
                "capital-expenditure": 10515.2,
                "net-present-cost": 11099.6,
                "operational-emissions": 134456
            },
            "evacuated-tube": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 36.1047,
                "capital-expenditure": 10625.2,
                "net-present-cost": 11156.3,
                "operational-emissions": 128096
            },
            "flat-plate-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -211.235,
                "capital-expenditure": 13155.2,
                "net-present-cost": 10047.9,
                "operational-emissions": -216005
            },
            "evacuated-tube-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -223.614,
                "capital-expenditure": 13265.2,
                "net-present-cost": 9975.85,
                "operational-emissions": -229065
            },
            "photovoltaic-thermal-hybrid": {
                "pv-size": 2,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 19.2099,
                "capital-expenditure": 11945.2,
                "net-present-cost": 12227.7,
                "operational-emissions": 101650
            }
        },
        "hydrogen-boiler": {
            "grey": {
                "operational-expenditure": 162.028,
                "capital-expenditure": 2120,
                "net-present-cost": 4503.41,
                "operational-emissions": 1263160
            },
            "blue": {
                "operational-expenditure": 307.523,
                "capital-expenditure": 2120,
                "net-present-cost": 6643.61,
                "operational-emissions": 198402
            },
            "green": {
                "operational-expenditure": 608.432,
                "capital-expenditure": 2120,
                "net-present-cost": 11069.9,
                "operational-emissions": 1314410
            }
        },
        "hydrogen-fuel-cell": {
            "grey": {
                "operational-expenditure": 157.018,
                "capital-expenditure": 25157.8,
                "net-present-cost": 27467.5,
                "operational-emissions": 1224100
            },
            "blue": {
                "operational-expenditure": 298.015,
                "capital-expenditure": 25157.8,
                "net-present-cost": 29541.6,
                "operational-emissions": 192267
            },
            "green": {
                "operational-expenditure": 589.62,
                "capital-expenditure": 25157.8,
                "net-present-cost": 33831,
                "operational-emissions": 1273770
            }
        },
        "gas-boiler": {
            "operational-expenditure": 132.268,
            "capital-expenditure": 1620,
            "net-present-cost": 3565.64,
            "operational-emissions": 605126
        },
        "biomass-boiler": {
            "operational-expenditure": 135.905,
            "capital-expenditure": 9750,
            "net-present-cost": 11749.1,
            "operational-emissions": 297603
        }
    }
}

const system_order = [
    'electric-boiler',
    'air-source-heat-pump',
    'ground-source-heat-pump',
    'biomass-boiler',
    'gas-boiler',
    'hydrogen-boiler',
    'hydrogen-fuel-cell'
];

const solar_order = [
    'none',
    'photovoltaic',
    'flat-plate',
    'evacuated-tube',
    'flat-plate-and-photovoltaic',
    'evacuated-tube-and-photovoltaic',
    'photovoltaic-thermal-hybrid',
]

const h2_order = ['green', 'blue', 'grey'];

const full_order = {
    'electric-boiler': solar_order,
    'air-source-heat-pump': solar_order,
    'ground-source-heat-pump': solar_order,
    'hydrogen-boiler': h2_order,
    'hydrogen-fuel-cell': h2_order,
    'biomass-boiler': undefined,
    'gas-boiler': undefined,
}

const system_colors = {
    'electric-boiler': 'red',
    'air-source-heat-pump': 'blue',
    'ground-source-heat-pump': 'green',
    'hydrogen-boiler': 'cyan',
    'hydrogen-fuel-cell': 'purple',
    'biomass-boiler': 'orange',
    'gas-boiler': 'black',
};

let colors = {
    'red': 'red',
    'orange': 'rgb(255, 106, 0)',
    'green': 'green',
    'cyan': 'rgb(0, 148, 255)',
    'blue': 'blue',
    'purple': 'rgb(255, 106, 255)',
    'black': 'black'
}

const solar_markers = {
    'none': 'cross',
    'photovoltaic': 'diamond',
    'flat-plate': 'circle',
    'evacuated-tube': 'square',
    'flat-plate-and-photovoltaic': 'uparrow',
    'evacuated-tube-and-photovoltaic': 'downarrow',
    'photovoltaic-thermal-hybrid': 'star',
};

const h2_markers = {
    'green': 'circle',
    'blue': 'square',
    'grey': 'uparrow',
};

const system_markers = {
    'electric-boiler': solar_markers,
    'air-source-heat-pump': solar_markers,
    'ground-source-heat-pump': solar_markers,
    'hydrogen-boiler': h2_markers,
    'hydrogen-fuel-cell': h2_markers,
    'biomass-boiler': ['square'],
    'gas-boiler': ['square'],
};

const display_names = {
    'electric-boiler': 'Electric Boiler',
    'air-source-heat-pump': 'Air Source Heat Pump',
    'ground-source-heat-pump': 'Ground Source Heat Pump',
    'hydrogen-boiler': 'Hydrogen Boiler',
    'hydrogen-fuel-cell': 'Hydrogen Fuel Cell',
    'biomass-boiler': 'Biomass Boiler',
    'gas-boiler': 'Gas Boiler',
    'none': 'None',
    'photovoltaic': 'Photovoltaic Panels',
    'flat-plate': 'Flat Plates',
    'evacuated-tube': 'Evacuated Tubes',
    'flat-plate-and-photovoltaic': 'Photovoltaic Panels & Evacuated Tubes',
    'evacuated-tube-and-photovoltaic': 'Photovoltaic Panels & Flat Plates',
    'photovoltaic-thermal-hybrid': 'Photovoltaic Thermal Hybrid',
    'green': 'Green-Sourced Hydrogen',
    'blue': 'Blue-Sourced Hydrogen',
    'grey': 'Grey-Sourced Hydrogen',
};

const info_display_names = {
    'thermal-energy-storage-volume': 'Water Tank Volume',
    'operational-expenditure': 'Yearly Cost',
    'capital-expenditure': 'Upfront Cost',
    'net-present-cost': 'Lifetime Cost',
    'operational-emissions': 'Yearly Emissions'
}

const info_display_units = {
    'pv-size': (value) => { return `${value}m<sup>2</sup>` },
    'solar-thermal-size': (value) => { return `${value}m<sup>2</sup>` },
    'thermal-energy-storage-volume': (value) => { return `${value}m<sup>3</sup>` },
    'operational-expenditure': (value) => { return `${display_sign(value)}£${Math.round(Math.abs(value))}` },
    'capital-expenditure': (value) => { return `${display_sign(value)}£${Math.round(Math.abs(value))}` },
    'net-present-cost': (value) => { return `${display_sign(value)}£${Math.round(Math.abs(value))}` },
    'operational-emissions': (value) => { return `${display_sign(value)}${Math.round(Math.abs(value / 1000))} kgCO<sub>2</sub>eq` }
}

const system_visible = {
    'electric-boiler': true,
    'air-source-heat-pump': true,
    'ground-source-heat-pump': true,
    'hydrogen-boiler': false,
    'hydrogen-fuel-cell': false,
    'biomass-boiler': true,
    'gas-boiler': true,
};

function set_system_visibility() {
    for (const [system_name, is_visible] of Object.entries(system_visible)) {
        let parent = document.getElementById('system-' + system_name);
        if (!is_visible) {
            parent.getElementsByClassName('header')[0].getElementsByClassName('show')[0].src = './assets/hidden.png';
            chart.data.datasets[system_order.indexOf(system_name)].hidden = true;
        }
    }
    chart.update();
}

// MENU

function display_sign(value) {
    if (value < 0) {
        return "-";
    } else {
        return "";
    }
}

function build_parent_header(system_name, color) {
    let header_div = document.createElement('div');
    header_div.classList.add('header');

    if (system_name == system_order[system_order.length - 1]) {
        header_div.classList.add('border-bottom');
    }

    let marker_div = document.createElement('div');
    marker_div.style.borderColor = colors[color];
    marker_div.classList.add('marker');

    let name_div = document.createElement('div');
    name_div.innerHTML = `<a href="" target="_blank" rel="noopener noreferrer">${display_names[system_name]}</a>`;
    name_div.classList.add('name');

    let visible_img = document.createElement('img');
    visible_img.src = "./assets/visible.png";
    visible_img.classList.add('show');
    visible_img.addEventListener('click', () => {
        if (visible_img.src.endsWith("hidden.png")) {
            visible_img.src = "./assets/visible.png";
            // console.log("show: ", visible_img.parentElement.parentElement.id);

            let system_name = visible_img.parentElement.parentElement.id.substr(7);
            console.log(system_name);

            chart.data.datasets[system_order.indexOf(system_name)].hidden = false;
            chart.update();
        } else {
            visible_img.src = "./assets/hidden.png";
            // console.log("hide: ", visible_img.parentElement.parentElement.id);
            let system_name = visible_img.parentElement.parentElement.id.substr(7);
            // console.log(system_name);

            chart.data.datasets[system_order.indexOf(system_name)].hidden = true;
            chart.update();
        }
    });

    let expand_div = document.createElement('div');
    expand_div.classList.add('expand');
    expand_div.addEventListener('click', () => toggle_expand_parent(expand_div));

    let expand_inner_div = document.createElement('div');
    expand_inner_div.classList.add();
    expand_div.appendChild(expand_inner_div);

    header_div.appendChild(marker_div);
    header_div.appendChild(name_div);
    header_div.appendChild(visible_img);
    header_div.appendChild(expand_div);
    return header_div;
}

function build_child_header(subsystem_name, shape, color) {
    let header_div = document.createElement('div');
    header_div.classList.add('header');

    let marker_img = document.createElement('img');
    marker_img.src = `./assets/${shape}-${color}.png`;
    marker_img.classList.add('marker');

    let name_div = document.createElement('div');
    name_div.innerHTML = `<a href="" target="_blank" rel="noopener noreferrer">${display_names[subsystem_name]}</a>`;
    name_div.classList.add('name');

    let expand_div = document.createElement('div');
    expand_div.classList.add('expand');
    expand_div.addEventListener('click', () => toggle_expand_child(expand_div));

    let expand_inner_div = document.createElement('div');
    expand_inner_div.classList.add();
    expand_div.appendChild(expand_inner_div);

    header_div.appendChild(marker_img);
    header_div.appendChild(name_div);
    header_div.appendChild(expand_div);
    return header_div;
}

function build_child_info(subsystem_name, system_properties) {
    function make_namevalue(name, value) {
        let namevalue_div = document.createElement('div');
        namevalue_div.classList.add('name-value');
        let label = document.createElement('label');
        label.innerHTML = `<a href="" target="_blank" rel="noopener noreferrer">${name}</a>`;

        let p = document.createElement('p');
        p.innerHTML = value;

        namevalue_div.appendChild(label);
        namevalue_div.appendChild(p);
        return namevalue_div;
    }

    let header_div = document.createElement('div');
    header_div.classList.add('info');

    for (const [property_name, property_value] of Object.entries(system_properties)) {
        let united_value = info_display_units[property_name](property_value);
        if (property_name == 'pv-size') {
            switch (subsystem_name) {
                case 'photovoltaic':
                case 'flat-plate-and-photovoltaic':
                case 'evacuated-tube-and-photovoltaic':
                    header_div.appendChild(make_namevalue('Photovolatic Panel Area', united_value));
                    break;
            }
        } else if (property_name == 'solar-thermal-size') {
            switch (subsystem_name) {
                case 'flat-plate':
                case 'flat-plate-and-photovoltaic':
                    header_div.appendChild(make_namevalue('Flat Plate Area', united_value));
                    break;
                case 'evacuated-tube':
                case 'evacuated-tube-and-photovoltaic':
                    header_div.appendChild(make_namevalue('Evacuated Tube Area', united_value));
                    break;
                case 'photovoltaic-thermal-hybrid':
                    header_div.appendChild(make_namevalue('Photovoltaic-Thermal-Hybrid Area', united_value));
                    break;
            }
        } else {
            header_div.appendChild(make_namevalue(info_display_names[property_name], united_value));
        }
    }

    return header_div;
}

function build_system_menu() {
    let system_menu = document.getElementById('system-menu');

    let animation_duration = 500; //duration in ms
    let menu_scroll_fnc = EASE_IN_OUT_QUINT(animation_duration);
    uss.setYStepLengthCalculator(
        menu_scroll_fnc,
        system_menu
    );

    for (const system_name of system_order) {
        sub_systems = output.systems[system_name];
        // console.log(system_name, sub_systems);

        let color = system_colors[system_name];

        let system_div = document.createElement('div');
        system_div.id = 'system-' + system_name;
        system_div.classList.add('parent', 'hide');
        system_div.appendChild(build_parent_header(system_name, color));

        let markers = system_markers[system_name];
        let children_div = document.createElement('div');
        children_div.classList.add('children');
        // console.log('markers:', markers);
        if (!Array.isArray(markers)) {
            for (const [subsystem_name, marker] of Object.entries(markers)) {
                let system_properties = sub_systems[subsystem_name];
                // console.log(subsystem_name, system_properties);
                let subsystem_div = document.createElement('div');
                subsystem_div.id = 'system-' + system_name + '-' + subsystem_name;
                subsystem_div.classList.add('child', 'hide');

                subsystem_div.appendChild(build_child_header(subsystem_name, markers[subsystem_name], color));
                subsystem_div.appendChild(build_child_info(subsystem_name, system_properties));
                children_div.appendChild(subsystem_div);
            }
        } else {
            // console.log(system_name, sub_systems);
            children_div.appendChild(build_child_info(system_name, sub_systems));
        }
        system_div.appendChild(children_div);
        system_menu.appendChild(system_div);
    }
}

function hide_all_menu_items() {
    let system_menu = document.getElementById('system-menu');
    let parents = system_menu.getElementsByClassName('parent');
    for (let parent of parents) {
        parent.classList.add('hide');
    }

    let childs = system_menu.getElementsByClassName('child');
    for (let child of childs) {
        child.classList.add('hide');
    }
}

function toggle_expand_parent(expand_div) {
    let parent = expand_div.parentElement.parentElement;

    if (parent.classList.contains('hide')) {
        hide_all_menu_items();
        parent.classList.remove('hide');
    } else {
        parent.classList.add('hide');
    }
}

function toggle_expand_child(expand_div) {
    let child = expand_div.parentElement.parentElement;

    if (child.classList.contains('hide')) {
        let children = child.parentElement;
        let childs = children.getElementsByClassName('child');
        for (let c of childs) {
            c.classList.add('hide');
        }

        child.classList.remove('hide');
    } else {
        child.classList.add('hide');
    }
}

function open_child(id) {
    hide_all_menu_items();
    let child = document.getElementById(id);
    child.classList.remove('hide');
    let parent = child.parentElement.parentElement;
    parent.classList.remove('hide');
    uss.scrollIntoView(child);
}

build_system_menu();

// setTimeout(() => { open_child('system-gas-boiler'); }, 3000);


// GRAPH

document.getElementById("y-param").selectedIndex = 1;

let marker_names = ['cross', 'diamond', 'circle', 'square', 'uparrow', 'downarrow', 'star'];
let marker_images = {
    'red': load_images('red'),
    'orange': load_images('orange'),
    'green': load_images('green'),
    'cyan': load_images('cyan'),
    'blue': load_images('blue'),
    'purple': load_images('purple'),
    'black': load_images('black')
};

const axes_label_map = {
    'capital-expenditure': "Upfront Cost (£1000's)",
    'operational-expenditure': "Yearly Cost (£'s)",
    'net-present-cost': "Lifetime Cost (£1000's)",
    'operational-emissions': "Yearly Emissions (tonnesCO2eq)",
}

const divisor_map = {
    'capital-expenditure': 1000,
    'operational-expenditure': 1,
    'net-present-cost': 1000,
    'operational-emissions': 1000000,
}


let point_radius = 6;
function load_images(color) {
    let marker_images = {};
    for (let [i, name] of marker_names.entries()) {
        marker_images[name] = new Image(8, 8);
        marker_images[name].src = `./assets/${name}-${color}.png`
    }
    return marker_images;
}

function replace_graph_data() {
    let x_select = document.getElementById("x-param");
    let x_param = x_select.options[x_select.selectedIndex].value;
    // console.log("x-param: ", x_param);

    let y_select = document.getElementById("y-param");
    let y_param = y_select.options[y_select.selectedIndex].value;
    // console.log("y-param: ", y_param);

    let x_divisor = divisor_map[x_param];
    let y_divisor = divisor_map[y_param];

    chart.options.scales.x.title.text = axes_label_map[x_param];
    chart.options.scales.y.title.text = axes_label_map[y_param];
    let i = 0;
    for (let system_name of system_order) {
        let dataset_data = [];
        switch (system_name) {
            case 'biomass-boiler':
            case 'gas-boiler':
                let values = output.systems[system_name];
                dataset_data.push({
                    'x': values[x_param] / x_divisor,
                    'y': values[y_param] / y_divisor
                });
                break;
            default:
                for (const subsystem_name of Object.keys(system_markers[system_name])) {

                    let values = output.systems[system_name][subsystem_name];
                    // console.log(subsystem_name, values);
                    dataset_data.push({
                        'x': values[x_param] / x_divisor,
                        'y': values[y_param] / y_divisor
                    });
                }
        }
        chart.data.datasets[i].data = dataset_data;
        i += 1;
    }
    chart.update();
}

function build_graph_data() {
    function datafill(n) {
        let data = [];
        for (let i = 0; i < n; i++) {
            data.push({ x: i, y: i });
        }
        return data;
    }

    let data = {};
    data['datasets'] = [];
    for (let system_name of system_order) {

        let color = system_colors[system_name];
        let rgb = colors[color];
        let markers = system_markers[system_name];
        let marker = undefined;

        let point_styles = [];
        if (!Array.isArray(markers)) {
            for (let [subsystem_name, marker] of Object.entries(markers)) {
                point_styles.push(marker_images[color][marker])
            }
        } else {
            point_styles.push(marker_images[color][markers[0]]);
            // console.log(point_styles);
        }

        // console.log(point_styles);
        data['datasets'].push({
            data: datafill(point_styles.length),
            radius: point_radius,
            label: system_name,
            backgroundColor: rgb,
            borderColor: rgb,
            pointStyle: point_styles,
        });
    }

    // console.log(data);
    return data;
}

let config = {
    type: 'scatter',
    data: build_graph_data(),
    options: {
        elements: {
            point: {
                pointStyle: 'circle',
            }
        },
        scales: {
            x: {
                type: 'linear',
                position: 'bottom',
                title: {
                    display: true,
                    text: 'Upfront Cost (£)',
                    font: {
                        size: 14,
                        family: 'Sora'
                    }
                },
                ticks: {
                    font: {
                        size: 12,
                        family: 'Sora'
                    }
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Yearly Emissions (kgCO2eq/yr)',
                    font: {
                        size: 14,
                        family: 'Sora'
                    }
                },
                ticks: {
                    font: {
                        size: 12,
                        family: 'Sora'
                    }
                }
            }
        },
        aspectRatio: 1,
        plugins: {
            legend: {
                display: false,
                labels: {
                    font: {
                        size: 20
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function (context) {
                        // console.log(context);

                        if (context.dataset.data.length == 1) {
                            return `${display_names[context.dataset.label]}`
                        } else {
                            return `${display_names[context.dataset.label]}, ${display_names[Object.keys(output.systems[context.dataset.label])[context.dataIndex]]}`
                        }

                    }
                },
                usePointStyle: true
            }
        }
    }
};

config.options.animation = {
    numbers: { duration: 0 },
    colors: {
        type: "color",
        duration: 1000,
        from: "transparent",
    }
}

const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, config);

chart.options.onClick = (e) => {
    let activePoints = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false)

    // make sure click was on an actual point
    if (activePoints.length > 0) {
        let context = activePoints[0];


        let system_id = system_order[context.datasetIndex];
        if (system_id == 'gas-boiler' || system_id == 'biomass-boiler') {
            open_child('system-' + system_id)
        } else {
            let subsystem_id = full_order[system_id][context.index];
            open_child('system-' + system_id + '-' + subsystem_id);
        }
    }

};

replace_graph_data();
set_system_visibility();
