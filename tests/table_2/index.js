const output = {
    "demand": {
        "boiler": {
            "hot-water": 1460.07,
            "space": 1515.96,
            "total": 2976.03,
            "peak-hourly": 8.36874
        },
        "heat-pump": {
            "hot-water": 1460.07,
            "space": 1552.12,
            "total": 3012.19,
            "peak-hourly": 1.56076
        }
    },
    "systems": {
        "electric-boiler": {
            "none": {
                "pv-size": 0,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 232.091,
                "capital-expenditure": 678.913,
                "net-present-cost": 4092.94,
                "operational-emissions": 644775
            },
            "photovoltaic": {
                "pv-size": 14,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -35.5481,
                "capital-expenditure": 3758.91,
                "net-present-cost": 3236.01,
                "operational-emissions": 214478
            },
            "flat-plate": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 173.86,
                "capital-expenditure": 3256.41,
                "net-present-cost": 5813.87,
                "operational-emissions": 507729
            },
            "evacuated-tube": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 157.84,
                "capital-expenditure": 3366.41,
                "net-present-cost": 5688.21,
                "operational-emissions": 463252
            },
            "flat-plate-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -39.0105,
                "capital-expenditure": 5896.41,
                "net-present-cost": 5322.57,
                "operational-emissions": 182792
            },
            "evacuated-tube-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -64.4958,
                "capital-expenditure": 6006.41,
                "net-present-cost": 5057.69,
                "operational-emissions": 115537
            },
            "photovoltaic-thermal-hybrid": {
                "pv-size": 4,
                "solar-thermal-size": 4,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 102.037,
                "capital-expenditure": 5323.91,
                "net-present-cost": 6824.87,
                "operational-emissions": 364656
            }
        },
        "air-source-heat-pump": {
            "none": {
                "pv-size": 0,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 79.5922,
                "capital-expenditure": 6237.67,
                "net-present-cost": 7408.46,
                "operational-emissions": 232146
            },
            "photovoltaic": {
                "pv-size": 14,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -197.882,
                "capital-expenditure": 9317.67,
                "net-present-cost": 6406.86,
                "operational-emissions": -182272
            },
            "flat-plate": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 58.3877,
                "capital-expenditure": 8815.17,
                "net-present-cost": 9674.04,
                "operational-emissions": 191942
            },
            "evacuated-tube": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 52.8353,
                "capital-expenditure": 8925.17,
                "net-present-cost": 9702.37,
                "operational-emissions": 178927
            },
            "flat-plate-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -171.235,
                "capital-expenditure": 11455.2,
                "net-present-cost": 8936.33,
                "operational-emissions": -153667
            },
            "evacuated-tube-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -186.652,
                "capital-expenditure": 11565.2,
                "net-present-cost": 8819.54,
                "operational-emissions": -177541
            },
            "photovoltaic-thermal-hybrid": {
                "pv-size": 2,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 37.9702,
                "capital-expenditure": 10245.2,
                "net-present-cost": 10803.7,
                "operational-emissions": 158842
            }
        },
        "ground-source-heat-pump": {
            "none": {
                "pv-size": 0,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 53.459,
                "capital-expenditure": 7937.67,
                "net-present-cost": 8724.04,
                "operational-emissions": 154280
            },
            "photovoltaic": {
                "pv-size": 14,
                "solar-thermal-size": 0,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -247.103,
                "capital-expenditure": 11017.7,
                "net-present-cost": 7382.83,
                "operational-emissions": -260026
            },
            "flat-plate": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 39.7321,
                "capital-expenditure": 10515.2,
                "net-present-cost": 11099.6,
                "operational-emissions": 134456
            },
            "evacuated-tube": {
                "pv-size": 0,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 36.1047,
                "capital-expenditure": 10625.2,
                "net-present-cost": 11156.3,
                "operational-emissions": 128096
            },
            "flat-plate-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -211.235,
                "capital-expenditure": 13155.2,
                "net-present-cost": 10047.9,
                "operational-emissions": -216005
            },
            "evacuated-tube-and-photovoltaic": {
                "pv-size": 12,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": -223.614,
                "capital-expenditure": 13265.2,
                "net-present-cost": 9975.85,
                "operational-emissions": -229065
            },
            "photovoltaic-thermal-hybrid": {
                "pv-size": 2,
                "solar-thermal-size": 2,
                "thermal-energy-storage-volume": 0.1,
                "operational-expenditure": 19.2099,
                "capital-expenditure": 11945.2,
                "net-present-cost": 12227.7,
                "operational-emissions": 101650
            }
        },
        "hydrogen-boiler": {
            "grey": {
                "operational-expenditure": 162.028,
                "capital-expenditure": 2120,
                "net-present-cost": 4503.41,
                "operational-emissions": 1263160
            },
            "blue": {
                "operational-expenditure": 307.523,
                "capital-expenditure": 2120,
                "net-present-cost": 6643.61,
                "operational-emissions": 198402
            },
            "green": {
                "operational-expenditure": 608.432,
                "capital-expenditure": 2120,
                "net-present-cost": 11069.9,
                "operational-emissions": 1314410
            }
        },
        "hydrogen-fuel-cell": {
            "grey": {
                "operational-expenditure": 157.018,
                "capital-expenditure": 25157.8,
                "net-present-cost": 27467.5,
                "operational-emissions": 1224100
            },
            "blue": {
                "operational-expenditure": 298.015,
                "capital-expenditure": 25157.8,
                "net-present-cost": 29541.6,
                "operational-emissions": 192267
            },
            "green": {
                "operational-expenditure": 589.62,
                "capital-expenditure": 25157.8,
                "net-present-cost": 33831,
                "operational-emissions": 1273770
            }
        },
        "gas-boiler": {
            "operational-expenditure": 132.268,
            "capital-expenditure": 1620,
            "net-present-cost": 3565.64,
            "operational-emissions": 605126
        },
        "biomass-boiler": {
            "operational-expenditure": 135.905,
            "capital-expenditure": 9750,
            "net-present-cost": 11749.1,
            "operational-emissions": 297603
        }
    }
}


const table_system_names = {
    'electric-boiler': 'EB',
    'air-source-heat-pump': 'ASHP',
    'ground-source-heat-pump': 'GSHP',
    'biomass-boiler': 'Biomass Boiler',
    'gas-boiler': 'Gas Boiler',
    'hydrogen-boiler': 'H<sub>2</sub>B',
    'hydrogen-fuel-cell': 'H<sub>2</sub>FC',
};

const long_table_system_names = {
    'electric-boiler': 'Electric Boiler',
    'air-source-heat-pump': 'Air Source Heat Pump',
    'ground-source-heat-pump': 'Ground Source Heat Pump',
    'biomass-boiler': 'Biomass Boiler',
    'gas-boiler': 'Gas Boiler',
    'hydrogen-boiler': 'Hydrogen Boiler',
    'hydrogen-fuel-cell': 'Hydrogen Fuel Cell',
};


const table_subsystem_names = {
    'none': () => { return 'None' },
    'photovoltaic': (properties) => { return [`PV<sub>${properties['pv-size']}</sub>`]; },
    'flat-plate': (properties) => { return [`FP<sub>${properties['solar-thermal-size']}</sub>`]; },
    'evacuated-tube': (properties) => { return [`ET<sub>${properties['solar-thermal-size']}</sub>`]; },
    'flat-plate-and-photovoltaic': (properties) => {
        return [`PV<sub>${properties['pv-size']}</sub>`, `FP<sub>${properties['solar-thermal-size']}</sub>`];
    },
    'evacuated-tube-and-photovoltaic': (properties) => {
        return [`PV<sub>${properties['pv-size']}</sub>`, `ET<sub>${properties['solar-thermal-size']}</sub>`];
    },
    'photovoltaic-thermal-hybrid': (properties) => { return [`PVT<sub>${properties['pv-size']}</sub>`]; },
    'green': () => { return 'Green' },
    'blue': () => { return 'Blue' },
    'grey': () => { return 'Grey' },
};


const long_table_subsystem_names = {
    'none': () => { return 'None' },
    'photovoltaic': (properties) => { return [`${properties['pv-size']}m<sup>2</sup> PV`]; },
    'flat-plate': (properties) => { return [`${properties['solar-thermal-size']}m<sup>2</sup> FP`]; },
    'evacuated-tube': (properties) => { return [`${properties['solar-thermal-size']}m<sup>2</sup> ET`]; },
    'flat-plate-and-photovoltaic': (properties) => {
        return [`${properties['pv-size']}m<sup>2</sup> PV`, `${properties['solar-thermal-size']}m<sup>2</sup> FP`];
    },
    'evacuated-tube-and-photovoltaic': (properties) => {
        return [`${properties['pv-size']}m<sup>2</sup> PV`, `${properties['solar-thermal-size']}m<sup>2</sup> ET`];
    },
    'photovoltaic-thermal-hybrid': (properties) => { return [`${properties['pv-size']}m<sup>2</sup> PVT`]; },
    'green': () => { return 'Green' },
    'blue': () => { return 'Blue' },
    'grey': () => { return 'Grey' },
};

let table_data = rebuild_data();


function rebuild_data() {
    let data = {
        'name': [],
        'long-name': [],
        'thermal-energy-storage-volume': [],
        'capital-expenditure': [],
        'operational-expenditure': [],
        'net-present-cost': [],
        'operational-emissions': [],
    };

    for (let system_name of Object.keys(table_system_names)) {
        switch (system_name) {
            case 'electric-boiler':
            case 'air-source-heat-pump':
            case 'ground-source-heat-pump':
            case 'hydrogen-boiler':
            case 'hydrogen-fuel-cell':
                for (let [subsystem_name, properties] of Object.entries(output.systems[system_name])) {
                    for (let property_name of Object.keys(data)) {
                        if (property_name == 'name') {
                            data[property_name].push([table_system_names[system_name]].concat(table_subsystem_names[subsystem_name](properties)));

                        } else if (property_name == 'long-name') {
                            data['long-name'].push([table_system_names[system_name]].concat(long_table_subsystem_names[subsystem_name](properties)));
                        } else {
                            data[property_name].push(properties[property_name]);
                        }
                    }
                }
                break;
            case 'biomass-boiler':
            case 'gas-boiler':
                for (let property_name of Object.keys(data)) {
                    if (property_name == 'name' || property_name == 'long-name') {
                        data[property_name].push([table_system_names[system_name]]);
                    } else {
                        data[property_name].push(output.systems[system_name][property_name]);
                    }
                }
                break;
        }
    }
    // console.log(data);
    return data;
}

function sort_indices(array, sortfnc) {
    let index_value_array = [];
    let i = 0;
    // console.log(array);
    for (let item of array) {
        index_value_array.push([item, i]);
        i += 1;
    }

    index_value_array.sort(sortfnc);
    let indices = [];
    for (let item of index_value_array) {
        indices.push(item[1]);
    }

    let index_value_array2 = [];
    i = 0;
    // console.log(indices);
    for (let item of indices) {
        index_value_array2.push([item, i]);
        i += 1;
    }

    index_value_array2.sort(sortfnc);
    let indices2 = [];
    for (let item of index_value_array2) {
        indices2.push(item[1]);
    }

    // console.log(index_value_array, indices2);
    return indices2;
}

function build_table() {
    const table_headers = {
        'name': 'System',
        'thermal-energy-storage-volume': '<div>m<sup>3</sup></div>',
        'capital-expenditure': '£',
        'operational-expenditure': '£/yr',
        'net-present-cost': '£/life',
        'operational-emissions': '<div>CO<sub>2</sub></div>',
    };

    const long_table_headers = {
        'name': 'System',
        'thermal-energy-storage-volume': 'Water Tank Volume (m<sup>3</sup>)',
        'capital-expenditure': 'Upfront Cost (£)',
        'operational-expenditure': 'Yearly Cost (£)',
        'net-present-cost': 'Lifetime Cost (£)',
        'operational-emissions': 'Yearly Emissions <div>(kgCO<sub>2</sub>Eq)</div>',
    };

    function money_fmt(v) {
        if (v > 1000 && window.innerWidth < 500) {
            return `${Math.round(v / 1000)}k`
        } else {
            return numberWithCommas(Math.round(v));
        }
    }

    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    const info_format = {
        'thermal-energy-storage-volume': (v) => {
            if (v == undefined) {
                return 'N/A';
            } else {
                return v;
            }
        },
        'capital-expenditure': (v) => { return money_fmt(v) },
        'operational-expenditure': (v) => { return money_fmt(v) },
        'net-present-cost': (v) => { return money_fmt(v) },
        'operational-emissions': (v) => { return Math.round(v / 1000) },
    }

    let table = document.getElementById('table');
    table.innerHTML = '';
    for (let [column_name, column_values] of Object.entries(table_data)) {
        if (column_name == 'long-name') { continue; }
        let column = document.createElement('div');
        column.classList.add('column');
        let h1 = document.createElement('h1');
        let h1p = document.createElement('p');
        if (window.innerWidth > 700) {
            h1p.innerHTML = long_table_headers[column_name];
        } else {
            h1p.innerHTML = table_headers[column_name];
        }

        h1.appendChild(h1p);
        h1.addEventListener('click', () => sort_table(column_name));
        column.appendChild(h1);
        if (column_name == 'name') {
            let names = window.innerWidth < 700 ? table_data.name : table_data['long-name'];
            // console.log(names);
            for (let name of Object.values(names)) {
                let name_div = document.createElement('div');
                name_div.classList.add('name', 'data');
                for (let part of name) {
                    let subname = document.createElement('p');
                    subname.innerHTML = part;
                    if (name.length == 1) {
                        subname.classList.add('only-child')
                    }
                    name_div.appendChild(subname);
                }
                column.appendChild(name_div);
            }
        } else {
            for (let item of column_values) {
                let p = document.createElement('p');
                p.classList.add('data');
                p.innerHTML = info_format[column_name](item);
                column.appendChild(p);
            }
        }
        table.appendChild(column);
    }


}

function sort_table(name) {
    // console.log('name', name);
    let order = name == 'name' ? Array.from(Array(29).keys()) : sort_indices([...table_data[name]], (a, b) => {
        return a[0] < b[0] ? -1 : 1;
    });

    let table = document.getElementById('table');
    let columns = table.getElementsByClassName('column');
    for (let column of columns) {
        let i = 0;
        for (let t of column.getElementsByClassName('data')) {
            t.style.order = order[i];
            i += 1;
        }
    }
}

let on_resize_end = undefined;
function reportWindowSize() {
    if (on_resize_end) {
        clearTimeout(on_resize_end);
    }
    on_resize_end = setTimeout(() => build_table(), 100);
}

build_table();

window.onresize = reportWindowSize;